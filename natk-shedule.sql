CREATE TABLE building (
    building_id SERIAL PRIMARY KEY,
    name TEXT NOT NULL,
    address TEXT NOT NULL UNIQUE
);

CREATE TABLE classroom (
    classroom_id SERIAL PRIMARY KEY,
    building_id INT NOT NULL REFERENCES building(building_id),
    room_number TEXT NOT NULL,
    UNIQUE (building_id, room_number)
);

CREATE TABLE teacher (
    teacher_id SERIAL PRIMARY KEY,
    last_name TEXT NOT NULL,
    first_name TEXT NOT NULL,
    middle_name TEXT,
    position TEXT NOT NULL
);

CREATE TABLE subject (
    subject_id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE
);

CREATE TABLE specialties (
    id SERIAL PRIMARY KEY,
    name TEXT NOT NULL
);

CREATE TABLE student_group (
    group_id SERIAL PRIMARY KEY,
    group_name TEXT NOT NULL UNIQUE,
    course INT NOT NULL CHECK (course BETWEEN 1 AND 6),
	specialty_id INT NOT NULL REFERENCES specialties(id)
);

CREATE TABLE weekday (
    weekday_id SERIAL PRIMARY KEY,
    name TEXT NOT NULL UNIQUE
);

CREATE TABLE lesson_time (
    lesson_time_id SERIAL PRIMARY KEY,
    lesson_number INT NOT NULL,
    time_start TIME NOT NULL,
    time_end TIME NOT NULL,
    UNIQUE (lesson_number, time_start, time_end)
);

CREATE TYPE lesson_group_part AS ENUM (
    'FULL',   -- вся группа
    'SUB1',   -- первая половина
    'SUB2'    -- вторая половина
);

CREATE TABLE schedule (
    schedule_id SERIAL PRIMARY KEY,
    lesson_date DATE NOT NULL,
    weekday_id INT NOT NULL REFERENCES weekday(weekday_id),
    lesson_time_id INT NOT NULL REFERENCES lesson_time(lesson_time_id),

	group_id INT NOT NULL REFERENCES student_group(group_id),
    group_part lesson_group_part NOT NULL DEFAULT 'FULL',
	
    subject_id INT NOT NULL REFERENCES subject(subject_id),
    teacher_id INT NOT NULL REFERENCES teacher(teacher_id),
    classroom_id INT NOT NULL REFERENCES classroom(classroom_id),
    -- нельзя чтобы одна и та же часть группы имела две пары одновременно
    UNIQUE (lesson_date, lesson_time_id, group_id, group_part),
	-- нельзя чтобы кабинет был занят дважды
    UNIQUE (lesson_date, lesson_time_id, classroom_id)
);

-- ДНИ НЕДЕЛИ
INSERT INTO weekday (name) VALUES
('Понедельник'),('Вторник'),('Среда'),('Четверг'),('Пятница'),('Суббота');

-- ПАРЫ
INSERT INTO lesson_time (lesson_number, time_start, time_end) VALUES
(1, '08:30', '10:10'),
(2, '10:20', '12:00'),
(3, '12:30', '14:10'),
(4, '14:20', '16:00');

-- ЗДАНИЯ
INSERT INTO building (name, address) VALUES
('Главный корпус', 'Красный проспект 72'),
('Учебный корпус №2', 'Ленина 15'),
('Лабораторный корпус', 'Советская 10'),
('Спортивный корпус', 'Парковая 5'),
('Библиотечный центр', 'Городская 2'),
('Институт ИТ', 'Университетская 20'),
('Физический корпус', 'Школьная 8'),
('Корпус инженерии', 'Космическая 11'),
('Корпус Экономики', 'Ленина 33'),
('Корпус Психологии', 'Октябрьская 11');

-- КАБИНЕТЫ
INSERT INTO classroom (building_id, room_number) VALUES
(1,'488'),(1,'485А'),(1,'240'),(1,'487'),(1,'474'),(1,'241'),(1,'356'),
(2,'101'),(2,'102'),(2,'105'),(2,'110'),(2,'201'),(2,'202'),(2,'203'),(2,'204'),(2,'205'),
(3,'301'),(3,'302'),(3,'303'),(3,'304'),(3,'305'),
(4,'401'),(4,'402'),(4,'403'),(4,'404'),(4,'405'),
(5,'501'),(5,'502'),(5,'503'),(5,'504'),(5,'505'),
(6,'601'),(6,'602'),(6,'603'),(6,'604'),(6,'605'),
(7,'701'),(7,'702'),(7,'703'),(7,'704'),(7,'705'),
(8,'801'),(8,'802'),(8,'803'),(8,'804'),(8,'805'),
(9,'901'),(9,'902'),(9,'903'),(9,'904'),(9,'905'),
(10,'1001'),(10,'1002'),(10,'1003'),(10,'1004'),(10,'1005');

-- ПРЕПОДАВАТЕЛИ (80)
INSERT INTO teacher (last_name, first_name, middle_name, position) VALUES
('Ветрова','Оксана','Васильевна','Преподаватель'),
('Машукова','Алеся','Игоревна','Преподаватель'),
('Винников','Александр','Александрович','Преподаватель'),
('Мосяев','Артём','Сергеевич','Преподаватель'),
('Алексина','Ольга','Алексеевна','Преподаватель'),
('Симонова','Елена','Петровна','Преподаватель'),
('Петров','Иван','Александрович','Доцент'),
('Смирнова','Мария','Игоревна','Преподаватель'),
('Кузнецов','Дмитрий','Михайлович','Старший преподаватель'),
('Попова','Екатерина','Владимировна','Преподаватель'),
('Иванов','Сергей','Петрович','Профессор'),
('Соколов','Николай','Васильевич','Ассистент'),
('Морозова','Алина','Романовна','Преподаватель'),
('Козлов','Артём','Олегович','Преподаватель'),
('Новикова','Ольга','Юрьевна','Доцент'),
('Медведев','Алексей','Ильич','Преподаватель'),
('Фролова','Татьяна','Сергеевна','Старший преподаватель'),
('Борисов','Роман','Александрович','Преподаватель'),
('Максимова','Елена','Николаевна','Преподаватель'),
('Гусев','Игорь','Андреевич','Преподаватель'),
('Лебедева','Светлана','Павловна','Преподаватель'),
('Власов','Павел','Дмитриевич','Преподаватель'),
('Дмитриева','Анна','Владимировна','Преподаватель'),
('Селиванов','Юрий','Викторович','Преподаватель'),
('Егорова','Ксения','Андреевна','Преподаватель'),
('Назаров','Константин','Игоревич','Преподаватель'),
('Орлов','Константин','Игоревич','Преподаватель'),
('Павлова','Анна','Викторовна','Преподаватель'),
('Романов','Илья','Александрович','Преподаватель'),
('Смирнова','Мария','Васильевна','Преподаватель'),
('Соколов','Николай','Петрович','Преподаватель'),
('Тарасова','Елена','Юрьевна','Преподаватель'),
('Фролов','Виктор','Александрович','Преподаватель'),
('Харитонова','Оксана','Сергеевна','Преподаватель'),
('Цветкова','Алина','Игоревна','Преподаватель'),
('Чистяков','Роман','Владимирович','Преподаватель'),
('Шишкина','Ирина','Павловна','Преподаватель'),
('Щербаков','Андрей','Сергеевич','Преподаватель'),
('Юрьев','Михаил','Владимирович','Преподаватель'),
('Яковлева','Наталья','Сергеевна','Преподаватель'),
('Герасимова','Ольга','Павловна','Преподаватель'),
('Демидов','Павел','Юрьевич','Старший преподаватель'),
('Ефремова','Екатерина','Владимировна','Преподаватель'),
('Жуков','Алексей','Николаевич','Ассистент'),
('Зайцева','Татьяна','Сергеевна','Преподаватель'),
('Калинина','Алина','Александровна','Преподаватель'),
('Кузнецова','Наталья','Васильевна','Доцент'),
('Лебедев','Артём','Дмитриевич','Преподаватель'),
('Максимова','Юлия','Игоревна','Преподаватель'),
('Назарова','Светлана','Павловна','Преподаватель'),
('Борисов','Роман','Александрович','Преподаватель'),
('Федоров','Михаил','Ильич','Преподаватель'),
('Морозова','Анна','Сергеевна','Преподаватель'),
('Кузнецов','Дмитрий','Александрович','Преподаватель'),
('Иванова','Екатерина','Павловна','Преподаватель'),
('Петров','Алексей','Сергеевич','Преподаватель'),
('Смирнов','Игорь','Владимирович','Преподаватель'),
('Лебедева','Светлана','Юрьевна','Преподаватель'),
('Винников','Александр','Сергеевич','Преподаватель'),
('Мосяев','Артём','Павлович','Преподаватель');

-- ПРЕДМЕТЫ (50)
INSERT INTO subject (name) VALUES
('Иностранный язык'),('Математика'),('Физика'),('Химия'),('Биология'),
('Информатика'),('Программирование'),('Базы данных'),('Алгоритмы'),('ОС и сети'),
('Этика'),('Философия'),('Экономика'),('История'),('География'),('Литература'),('Русский язык'),
('Физическая культура'),('Проектирование ПО'),('Цифровая грамотность'),
('Английский язык'),('Английский язык в профессиональной деятельности'),
('Французский язык'),('Испанский язык'),('Немецкий язык'),('Правоведение'),('Социология'),
('Психология'),('Маркетинг'),('Управление проектами'),('Управление рисками'),('Дизайн интерфейсов'),
('Мобильная разработка'),('Веб-разработка'),('Искусственный интеллект'),('Машинное обучение'),
('Робототехника'),('Интернет вещей'),('Электротехника'),('Логика'),('Дискретная математика'),
('Теория вероятностей'),('Статистика'),('Проектный менеджмент'),('Моделирование процессов'),('Кибербезопасность'),('Графический дизайн');

-- СПЕЦИАЛЬНОСТИ
INSERT INTO specialties (name) VALUES
('Информационные системы'),
('Прикладная информатика'),
('Математика и технологии'),
('Физика'),
('Биология'),
('Химия'),
('Экономика'),
('География'),
('Психология'),
('Юриспруденция'),
('ИТ и программирование');

-- ГРУППЫ
INSERT INTO student_group (group_name, course, specialty_id) VALUES
('ИС-11',1,1),('ИС-12',1,1),('ИС-13',1,1),('ИС-14',1,1),
('ПИ-21',2,2),('ПИ-22',2,2),('ПИ-23',2,2),('ПИ-24',2,2),
('МТ-31',3,3),('МТ-32',3,3),('МТ-33',3,3),('МТ-34',3,3),
('ФИ-41',4,4),('ФИ-42',4,4),('ФИ-43',4,4),('ФИ-44',4,4),
('БИ-11',1,5),('БИ-12',1,5),('БИ-13',1,5),('БИ-14',1,5),
('ХИ-21',2,6),('ХИ-22',2,6),('ХИ-23',2,6),('ХИ-24',2,6),
('ЭКО-31',3,7),('ЭКО-32',3,7),('ЭКО-33',3,7),('ЭКО-34',3,7),
('ГЕО-11',1,8),('ГЕО-12',1,8),('ГЕО-13',1,8),('ГЕО-14',1,8),
('ПС-21',2,9),('ПС-22',2,9),('ПС-23',2,9),('ПС-24',2,9),
('ЮР-41',4,10),('ЮР-42',4,10),('ЮР-43',4,10),('ЮР-44',4,10),
('ПСИХ-31',3,9),('ПСИХ-32',3,9),('ПСИХ-33',3,9),('ПСИХ-34',3,9),
('ИТ-15',1,11),('ИТ-16',1,11),('ИТ-17',1,11),('ИТ-18',1,11),('ИТ-19',1,11);

-- ================== РАСПИСАНИЕ ==================
-- Простое расписание на 30 дней, 4 пары в день на подгруппу
INSERT INTO schedule
(lesson_date, weekday_id, lesson_time_id, group_id, group_part, subject_id, teacher_id, classroom_id)

SELECT
    s.lesson_date,
    s.weekday_id,
    s.lesson_time_id,
    s.group_id,
    s.group_part,
    s.subject_id,
    s.teacher_id,
    c.classroom_id
FROM (
    SELECT
        d::date AS lesson_date,
        EXTRACT(ISODOW FROM d)::int AS weekday_id,
        lt.lesson_time_id,
        g.group_id,

        CASE
            WHEN subj.name ILIKE 'Английский%' THEN part.part
            ELSE 'FULL'
        END::lesson_group_part AS group_part,

        subj.subject_id,

        CASE
            WHEN subj.name ILIKE 'Английский%' AND part.part='SUB1' THEN (g.group_id % 60 + 1)
            WHEN subj.name ILIKE 'Английский%' AND part.part='SUB2' THEN ((g.group_id+10) % 60 + 1)
            ELSE (g.group_id % 60 + 1)
        END AS teacher_id,

        ROW_NUMBER() OVER (
            PARTITION BY d, lt.lesson_time_id
            ORDER BY g.group_id, part.part
        ) AS rn

    FROM generate_series('2026-01-12'::date, '2026-02-11'::date, '1 day') d
    CROSS JOIN lesson_time lt
    CROSS JOIN student_group g

    JOIN subject subj
      ON subj.subject_id =
         CASE
           WHEN g.group_id % 2 = 0 AND lt.lesson_time_id IN (1,3)
             THEN 21
           ELSE ((g.group_id + lt.lesson_time_id) % 49 + 1)
         END

    LEFT JOIN (VALUES ('SUB1'),('SUB2')) part(part)
      ON subj.name ILIKE 'Английский%'

    WHERE EXTRACT(ISODOW FROM d) <= 6
) s
JOIN (
    SELECT
        classroom_id,
        ROW_NUMBER() OVER (ORDER BY classroom_id) AS rn
    FROM classroom
) c
ON c.rn = s.rn;